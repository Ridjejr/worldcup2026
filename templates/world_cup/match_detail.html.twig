{% extends 'base.html.twig' %}

{% block title %}
    {% if domicile and exterieur %}
        {{ domicile.equipe.nomEquipe }} vs {{ exterieur.equipe.nomEquipe }}
    {% else %}
        D√©tail du match
    {% endif %}
{% endblock %}

{% block stylesheets %}
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        /* --- Styles de la maquette --- */
        body { font-family: 'Inter', sans-serif; background: #0f1419; color: #ffffff; margin: 0; }
        .match-hero { background: linear-gradient(180deg, #1a1f2e 0%, #0f1419 100%); padding: 48px 0; border-bottom: 1px solid #2a3441; }
        .hero-container { max-width: 1440px; margin: 0 auto; padding: 0 48px; }
        
        .header { background: #1a1f2e; border-bottom: 1px solid #2a3441; padding: 20px 48px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { color: #8899a6; text-decoration: none; font-weight: 600; }
        .back-btn:hover { color: #00ff87; }

        .match-meta { display: flex; flex-direction: column; align-items: center; gap: 12px; margin-bottom: 32px; text-align: center; }
        .match-phase { background: #2a3441; color: #8899a6; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 700; text-transform: uppercase; }
        .match-venue { color: #60efff; font-size: 14px; font-weight: 600; }
        
        .match-status-badge { padding: 8px 20px; border-radius: 20px; font-weight: 700; font-size: 14px; text-transform: uppercase; margin-top: 8px; }
        .status-live { background: #00ff87; color: #0f1419; animation: pulse 2s infinite; }
        .status-finished { background: #2a3441; color: #8899a6; }
        .status-scheduled { background: #2a3441; color: #60efff; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        .hero-teams { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 40px; }
        .hero-team { display: flex; flex-direction: column; align-items: center; gap: 16px; }
        .hero-flag { font-size: 80px; line-height: 1; filter: drop-shadow(0 0 20px rgba(0,0,0,0.5)); }
        .hero-team-name { font-family: 'Bebas Neue', cursive; font-size: 40px; text-align: center; letter-spacing: 1px; }
        
        .hero-score-board { display: flex; flex-direction: column; align-items: center; }
        .large-score { font-family: 'Bebas Neue', cursive; font-size: 96px; line-height: 1; color: #00ff87; display: flex; gap: 24px; align-items: center; }
        .score-separator { color: #2a3441; }
        .match-time { background: #2a3441; color: #00ff87; padding: 8px 16px; border-radius: 8px; font-weight: 700; margin-top: 16px; font-size: 20px; }

        /* Stats Grid (Hero) */
        .hero-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 48px; max-width: 800px; margin-left: auto; margin-right: auto; }
        .hero-stat-card { background: #1a1f2e; border: 1px solid #2a3441; border-radius: 12px; padding: 16px; text-align: center; }
        .hero-stat-val { font-family: 'Bebas Neue', cursive; font-size: 28px; color: #00ff87; }
        .hero-stat-label { color: #8899a6; font-size: 12px; font-weight: 700; text-transform: uppercase; margin-top: 4px; }

        /* Content Layout */
        .content { max-width: 1440px; margin: 0 auto; padding: 32px 48px; display: grid; grid-template-columns: 1fr 350px; gap: 32px; }
        
        /* Timeline */
        .section-box { background: #1a1f2e; border: 1px solid #2a3441; border-radius: 16px; padding: 32px; margin-bottom: 24px; }
        .section-title { font-family: 'Bebas Neue', cursive; font-size: 24px; color: white; margin-bottom: 24px; letter-spacing: 1px; }
        
        .timeline-item { display: flex; gap: 20px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #2a3441; }
        .timeline-item:last-child { border-bottom: none; margin-bottom: 0; }
        .timeline-time { background: #00ff87; color: #0f1419; padding: 6px 10px; border-radius: 6px; font-weight: 700; font-size: 16px; height: fit-content; min-width: 50px; text-align: center; }
        .event-type { font-weight: 700; color: #00ff87; font-size: 15px; margin-bottom: 4px; display: block; }
        .event-player { font-weight: 600; color: white; }
        .event-detail { color: #8899a6; font-size: 13px; }

        /* Sidebar info */
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #2a3441; font-size: 14px; }
        .info-label { color: #8899a6; }
        .info-val { font-weight: 600; text-align: right; }

        /* Barres de stats */
        .stat-row { margin-bottom: 16px; }
        .stat-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px; font-weight: 600; }
        .stat-label-center { color: #8899a6; font-size: 12px; text-transform: uppercase; }
        .bar-container { display: flex; height: 6px; gap: 4px; }
        .bar { background: #2a3441; flex: 1; border-radius: 3px; overflow: hidden; display: flex; }
        .bar-fill { background: #00ff87; height: 100%; }
        .bar.reverse { justify-content: flex-end; }
        .bar.reverse .bar-fill { background: #60efff; }

        @media (max-width: 1024px) {
            .content { grid-template-columns: 1fr; }
            .hero-teams { gap: 20px; }
            .hero-stat-card { display: none; }
        }
    </style>
{% endblock %}

{% block body %}
    <div class="header">
        <a href="{{ path('app_home') }}" class="back-btn">‚Üê Retour √† l'accueil</a>
        <div style="font-family: 'Bebas Neue'; font-size: 24px; color: #00ff87;">COUPE DU MONDE 2026</div>
    </div>

    <section class="match-hero">
        <div class="hero-container">
            <div class="match-meta">
                <div class="match-phase">{{ match.phase.libelle }}</div>
                <div class="match-venue">üèüÔ∏è {{ match.stade.nom }} ‚Ä¢ {{ match.stade.ville }}</div>
                
                {% if liveData %}
                    {% set status = liveData.fixture.status.short %}
                    {% if status in ['1H', '2H', 'ET', 'P', 'BT'] %}
                        <div class="match-status-badge status-live">‚óè EN DIRECT {{ liveData.fixture.status.elapsed }}'</div>
                    {% elseif status == 'FT' or status == 'AET' or status == 'PEN' %}
                        <div class="match-status-badge status-finished">TERMIN√â</div>
                    {% else %}
                        <div class="match-status-badge status-scheduled">{{ match.dateHeure|date('H:i') }}</div>
                    {% endif %}
                {% else %}
                    <div class="match-status-badge status-scheduled">{{ match.dateHeure|date('H:i') }}</div>
                {% endif %}
            </div>

            <div class="hero-teams">
                <div class="hero-team">
                    <div class="hero-flag">{{ domicileDrapeau }}</div>
                    <div class="hero-team-name">{{ domicile.equipe.nomEquipe }}</div>
                </div>

                <div class="hero-score-board">
                    <div class="large-score">
                        <span>{{ liveData.goals.home ?? (domicile.buts ?? 0) }}</span>
                        <span class="score-separator">-</span>
                        <span>{{ liveData.goals.away ?? (exterieur.buts ?? 0) }}</span>
                    </div>
                    {% if liveData and liveData.fixture.status.short in ['PEN'] %}
                         <div style="color: #8899a6; margin-top: 8px;">(TAB: {{ liveData.score.penalty.home }} - {{ liveData.score.penalty.away }})</div>
                    {% endif %}
                </div>

                <div class="hero-team">
                    <div class="hero-flag">{{ exterieurDrapeau }}</div>
                    <div class="hero-team-name">{{ exterieur.equipe.nomEquipe }}</div>
                </div>
            </div>

            {% if liveData and liveData.statistics is defined and liveData.statistics|length >= 2 %}
                {% set statsHome = liveData.statistics[0].statistics %}
                {% set statsAway = liveData.statistics[1].statistics %}
                
                <div class="hero-stats">
                    {% for stat in statsHome %}
                        {% if stat.type == 'Ball Possession' %}
                            <div class="hero-stat-card">
                                <div class="hero-stat-val">{{ stat.value ?? '0%' }} - {{ statsAway[loop.index0].value ?? '0%' }}</div>
                                <div class="hero-stat-label">Possession</div>
                            </div>
                        {% endif %}
                        {% if stat.type == 'Total Shots' %}
                            <div class="hero-stat-card">
                                <div class="hero-stat-val">{{ stat.value ?? 0 }} - {{ statsAway[loop.index0].value ?? 0 }}</div>
                                <div class="hero-stat-label">Tirs</div>
                            </div>
                        {% endif %}
                        {% if stat.type == 'Corner Kicks' %}
                            <div class="hero-stat-card">
                                <div class="hero-stat-val">{{ stat.value ?? 0 }} - {{ statsAway[loop.index0].value ?? 0 }}</div>
                                <div class="hero-stat-label">Corners</div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </section>

    <div class="content">
        <main>
            {% if liveData and liveData.events is defined %}
                <div class="section-box">
                    <h2 class="section-title">‚è±Ô∏è Chronologie du match</h2>
                    
                    {% if liveData.events|length == 0 %}
                        <p style="color: #8899a6; text-align: center;">Le match n'a pas encore commenc√© ou aucun √©v√©nement majeur.</p>
                    {% endif %}

                    {% for event in liveData.events|reverse %}
                        <div class="timeline-item">
                            <div class="timeline-time">{{ event.time.elapsed }}{% if event.time.extra %}+{{ event.time.extra }}{% endif %}'</div>
                            <div style="flex: 1;">
                                <span class="event-type">
                                    {% if event.type == 'Goal' %}‚öΩ BUT !
                                    {% elseif event.type == 'Card' and event.detail == 'Yellow Card' %}üü® Carton Jaune
                                    {% elseif event.type == 'Card' and event.detail == 'Red Card' %}üü• Carton Rouge
                                    {% elseif event.type == 'subst' %}üîÑ Changement
                                    {% elseif event.type == 'Var' %}üì∫ VAR
                                    {% else %}{{ event.type }}{% endif %}
                                </span>
                                <div class="event-player">
                                    {{ event.player.name }} 
                                    <span style="font-weight: 400; color: #8899a6;">({{ event.team.name }})</span>
                                </div>
                                {% if event.assist.name %}
                                    <div class="event-detail">Passe : {{ event.assist.name }}</div>
                                {% endif %}
                                {% if event.type == 'subst' %}
                                    <div class="event-detail" style="color: #00ff87;">Entr√©e : {{ event.assist.name }}</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if liveData and liveData.lineups is defined and liveData.lineups|length >= 2 %}
                <div class="section-box">
                    <h2 class="section-title">üìã Compositions</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="color: #00ff87; margin-bottom: 10px;">{{ liveData.lineups[0].team.name }} <span style="font-size: 12px; color: #fff;">({{ liveData.lineups[0].formation }})</span></h3>
                            {% for player in liveData.lineups[0].startXI %}
                                <div style="padding: 6px 0; border-bottom: 1px solid #2a3441; font-size: 14px;">
                                    <span style="color: #8899a6; width: 25px; display: inline-block;">{{ player.player.number }}</span>
                                    {{ player.player.name }}
                                </div>
                            {% endfor %}
                            <h4 style="color: #8899a6; margin-top: 15px; margin-bottom: 5px;">Rempla√ßants</h4>
                            {% for player in liveData.lineups[0].substitutes %}
                                <div style="padding: 4px 0; font-size: 13px; color: #8899a6;">
                                    {{ player.player.name }}
                                </div>
                            {% endfor %}
                        </div>
                         <div>
                            <h3 style="color: #60efff; margin-bottom: 10px;">{{ liveData.lineups[1].team.name }} <span style="font-size: 12px; color: #fff;">({{ liveData.lineups[1].formation }})</span></h3>
                            {% for player in liveData.lineups[1].startXI %}
                                <div style="padding: 6px 0; border-bottom: 1px solid #2a3441; font-size: 14px;">
                                    <span style="color: #8899a6; width: 25px; display: inline-block;">{{ player.player.number }}</span>
                                    {{ player.player.name }}
                                </div>
                            {% endfor %}
                             <h4 style="color: #8899a6; margin-top: 15px; margin-bottom: 5px;">Rempla√ßants</h4>
                             {% for player in liveData.lineups[1].substitutes %}
                                 <div style="padding: 4px 0; font-size: 13px; color: #8899a6;">
                                     {{ player.player.name }}
                                 </div>
                             {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </main>

        <aside>
            <div class="section-box">
                <h3 class="section-title" style="font-size: 20px;">‚ÑπÔ∏è Infos du match</h3>
                <div class="info-row">
                    <span class="info-label">Date</span>
                    <span class="info-val">{{ match.dateHeure|date('d F Y') }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Heure</span>
                    <span class="info-val">{{ match.dateHeure|date('H:i') }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Stade</span>
                    <span class="info-val">{{ match.stade.nom }}</span>
                </div>
                {% if liveData and liveData.fixture.referee %}
                    <div class="info-row">
                        <span class="info-label">Arbitre</span>
                        <span class="info-val">{{ liveData.fixture.referee }}</span>
                    </div>
                {% endif %}
            </div>

            {% if liveData and liveData.statistics is defined and liveData.statistics|length >= 2 %}
            <div class="section-box">
                <h3 class="section-title" style="font-size: 20px;">üìä Stats Globales</h3>
                {% set statsHome = liveData.statistics[0].statistics %}
                {% set statsAway = liveData.statistics[1].statistics %}
                
                {% for stat in statsHome %}
                    {# On nettoie la valeur : on remplace '%' par rien, et on s'assure que c'est 0 si null #}
                    {% set rawValH = stat.value ?? 0 %}
                    {% set rawValA = statsAway[loop.index0].value ?? 0 %}
                    
                    {# On convertit en cha√Æne pour utiliser replace, puis en nombre #}
                    {% set valH = rawValH|replace({'%': ''}) %}
                    {% set valA = rawValA|replace({'%': ''}) %}
                    
                    {# Maintenant l'addition est s√ªre #}
                    {% set total = valH + valA %}
                    
                    {# On affiche seulement si au moins une valeur n'est pas 0 #}
                    {% if total > 0 %}
                        {% set pctH = (valH / total) * 100 %}
                        {% set pctA = (valA / total) * 100 %}
                        
                        <div class="stat-row">
                            <div class="stat-header">
                                {# On r√©utilise rawValH pour l'affichage (avec le % si il y √©tait) #}
                                <span style="color: #00ff87;">{{ rawValH }}</span>
                                <span class="stat-label-center">{{ stat.type }}</span>
                                <span style="color: #60efff;">{{ rawValA }}</span>
                            </div>
                            <div class="bar-container">
                                <div class="bar">
                                    <div class="bar-fill" style="width: {{ pctH }}%"></div>
                                </div>
                                <div class="bar reverse">
                                    <div class="bar-fill" style="width: {{ pctA }}%"></div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </aside>
    </div>
    {% block javascripts %}
    <script>
        // Si le match est en direct
        document.addEventListener('DOMContentLoaded', function() {
            const liveBadge = document.querySelector('.status-live');
            
            if (liveBadge) {
                console.log("Match en direct : rafra√Æchissement...");
                setTimeout(function(){
                    window.location.reload();
                }, 7000); // 7000ms = 7 secondes
            }
        });
    </script>
{% endblock %}
{% endblock %}